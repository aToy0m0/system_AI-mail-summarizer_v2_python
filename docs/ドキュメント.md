
機能などの列挙
・pleasanterのAPIで、特定案件のメールをフィルタして取得
・取得したメールの不要部分を削除（二つ目のFrom: 以下を切り捨てて、過去スレッド部分を消す）
・クレンジング後のメール全体をPSQLに保存
・バックエンドはDifyのAPI経由でLLMによる要約処理
・webの「原因」(およそ200文字以内)「解決策」(およそ200文字以内)「経緯」(制限なし。目安はA4ドキュメント1ページ分)フォームに、AIの要約結果を記入し画面更新
・各フォームのラベル付近には「修正対象」のチェックボックスがあり、チェックした場合はLLM-APIの送信に含まれる
・ユーザーはフォームを確認後、フォームを直接修正したり、AIに指示して追加修正させることが可能
・作業後は「Pleasanterに保存」ボタンで、「原因」「解決策」「経緯」を帳票生成用サイトに保存する
・会話履歴はDifyのAPIで呼び出されるので保存しない
・会話(conversation_id)に紐づけた最新のフォーム内容()はDBに保存する
・user情報とフォーム情報はテーブルを分ける
・ORMでプログラムを簡素化する
・UI；
　・サイドバーから過去の会話履歴及び最新のフォーム内容を呼び出せる
　・ヘッダーはタイトルとサイドバー用の3本線のみ
　・メインコンテンツは2段組みで
・メニュー列挙；
　・※メニューはサイドバーの上部に集約
　・新規会話；新しいconversation_idで会話を始める
　・Pleasanterに保存；最新のフォーム内容を帳票生成用サイトに保存
　・アカウント管理；ユーザー自身のアカウント管理機能を集約したプルダウンを開く
　　・ログアウト；
　　・パスワード変更；
　・ドキュメント；各種リンクを別のタブで開く
　　・Plesasanter；
　　・マニュアル；
・認証；
　・ID/Password認証
　・DBに保存する
・コンテナ
　・webコンテナ
　・postgresコンテナ
　・dockercompose.ymlを使う
　・認証情報は.envに記載し、コンテナ起動時(docker compose up -d)に読み込む


追加で詰める（設計・壁打ちポイント）

■ 1) メール取得（Pleasanter）
・「特定案件」の絞り込み条件（案件ID、サイト/テーブル、検索API、件名/差出人/期間など）
 → 親テーブル(案件サイト)にリンクした、子テーブル(メールサイト)を検索
    ・案件サイトID：98
    ・メールサイトID：91
    ・フィルタ条件：子テーブルのClassD＝親サイトのレコードID(ResultId)
    ・200レコード以上ある場合はOffsetを設定して再取得が必要だが、実装しない。(要件が200件以下なので。)
    ・実装の設定値：`.env` の `PLEASANTER_CASE_SITE_ID` / `PLEASANTER_MAIL_SITE_ID` / `PLEASANTER_MAIL_LINK_COLUMN` を参照する
・メール本文の取得元（Pleasanterの添付/本文フィールド/別ストレージ）と、正本データの扱い
 → 「メール本文がどこに入っている前提で作るか」と「保存する原本をどれにするか」を決める、という意味。
    ・本文の取得元：メールサイトの本文カラム（例：Body / MailBody / Text 等）を正とする（添付ファイルは対象外）
      - 実装の設定値：`.env` の `PLEASANTER_MAIL_BODY_COLUMN`（デフォルト: Body）
    ・正本データ（原本）の扱い：DBには “加工前(raw)” と “加工後(cleaned)” を分けて保存する
      - raw：Pleasanter から取得した本文そのまま（監査・再要約・不具合調査用）
      - cleaned：要約入力用にクレンジングした本文
    ・画面表示：基本は cleaned を表示し、必要なら raw を参照できるようにする（後で要件化）
・重複排除のキー（PleasanterのレコードID + メールID 等）と再実行時の冪等性
 → 同じ案件を何度取り込み直しても、DBに同じメールが増殖しないようにする、という意味。
    ・重複排除キー：まずは「メールサイトの ResultId（レコードID）」を一意キーとして扱うのが最も簡単
      - 可能なら補助キーとして Message-ID（メールヘッダ）や本文ハッシュも検討
    ・冪等性（べきとうせい）：同じ入力（同じ案件ID/同じ期間）で再実行しても、結果が同じ（重複INSERTしない）
      - 例：既に取り込んだ ResultId はスキップ、または raw/cleaned を上書き更新（どちらにするか要件化）

■ 2) クレンジング仕様
・「二つ目のFrom: 以下を切る」以外のルール（引用行 `>`、転送ヘッダ、署名、HTMLメール）
 → なし
・添付ファイル（PDF/画像）を要約対象に含めるか（OCRやPDF抽出の要否）
 → 含めない
・個人情報/機密情報のマスキング方針（保存前に伏せるか、表示時に伏せるか）
 → マスクしない

■ 3) Dify（LLM）入出力契約
・要約結果のフォーマット（JSON固定か、テンプレ文章か）とパース失敗時の扱い
  → おすすめ：可能なら Dify の「JSON Schema Output」を有効化して、JSON固定にする（モデル依存）。
    - JSON Schema が使えない場合は「テンプレ文章（見出し固定）」に落とし、サーバ側でパースする。
  → JSON Schema（例：llm_comment/cause/solution/details の4項目）
     参考サイト：https://legacy-docs.dify.ai/ja-jp/learn-more/extended-reading/how-to-use-json-schema-in-dify
```json
{
    "name": "incident_summary_schema",
    "description": "業務メール要約（原因/解決策/経緯）＋補足コメント",
    "strict": true,
    "schema": {
        "type": "object",
        "properties": {
            "llm_comment": {
                "type": "string",
                "description": "要約/推敲の観点・注意点などの補足（ユーザー向け）。短く。"
            },
            "cause": {
                "type": "string",
                "description": "原因（200文字以内）",
                "maxLength": 200
            },
            "solution": {
                "type": "string",
                "description": "解決策（200文字以内）",
                "maxLength": 200
            },
            "details": {
                "type": "string",
                "description": "経緯（制限なし。目安A4 1ページ。箇条書き可）"
            }
        },
        "required": ["llm_comment", "cause", "solution", "details"],
        "additionalProperties": false
    }
}
```
  → パース失敗時：フォームは更新せず、AIの生回答を表示してユーザーが手修正する（後で再送可）
・「原因/解決策/経緯」の文字数制限（200文字は“文字”か“バイト”か）と超過時の丸め方
  → おすすめ：まずは「文字数（=Pythonのlen相当）」で200を扱う。AI出力はサーバ側で200文字に丸める（強制）。
    - 保存先が「バイト制限」なら UTF-8 のバイト数で評価し直す（要件確定が必要）
・追加指示（ユーザーの追記修正）時に、どのフィールドを渡すか（チェックボックスの仕様の確定）
  → チェックされたフィールドだけを「フォーム内容」としてDifyへ送る（未チェックは文脈から除外する）
・ストリーミング表示の要否（UX）とタイムアウト/リトライ方針
  → MVPは blocking でOK。遅い場合のみ streaming を検討（実装コストが上がる）

■ 4) 会話（conversation_id）とデータの紐付け
・conversation_id と案件/メール/ユーザーの関連（1案件=1会話？ 1メール=1会話？）
 → 1案件=1会話。親テーブルの案件IDと紐づける
・サイドバーの「過去会話」の表示項目（タイトル、更新日時、案件番号等）
 → 親レコードのIDとタイトル(Title)を表示する
・「最新フォーム内容」の定義（会話ごとに1レコード上書きか、履歴を残すか）
 → 履歴不要

■ 5) 保存先（Pleasanter/帳票生成用サイト）
・保存するフィールドのマッピング（どのPleasanter項目に「原因/解決策/経緯」を入れるか）
・保存失敗時の扱い（再送、差分表示、ロールバック）
・帳票生成用サイトが期待するAPI仕様（認証、ペイロード、文字コード、レスポンス）

■ 6) 認証/権限
・ユーザー登録の方法（初期管理者、招待制、自己登録禁止など）
・権限（ユーザーは自分の会話だけ閲覧/編集）と監査ログの要否
・セッション保持（Cookie、期限、ログアウト）

■ 7) 運用・デプロイ
・環境変数（DB/Dify/Pleasanter）の一覧と、開発/本番の切り替え
・DBマイグレーション（create_all で始めるか Alembic を導入するか）
・バックアップ/保持期間（メール本文・要約結果）
